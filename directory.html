<html>
  <script>
    const tap = (getMessage) => (passThrough) => {
      console.log(getMessage(passThrough));

      return passThrough;
    };

    const backoff = (retryCount) => {
      return new Promise((resolve, reject) => {
          const backoffTime = Math.floor(Math.random() * Math.pow(2, retryCount - 1) * 1000);
        setTimeout(() => {
          resolve(backoffTime);
        }, backoffTime);
      });
    };

    // PCO = Planning Center Online
    const requestPCO = (access_token) => (apiEndpoint, retryCount = 1) => {
      return fetch(apiEndpoint, {
        headers: {
          Authorization: `Bearer ${access_token}`
        }
      }).then((response) => response.json()).catch((error) => {
        if (retryCount <= window.directoryPOC.MAX_RETRY) {
          return backoff(retryCount).then(() => window.directoryPOC.apiRequest(apiEndpoint, retryCount + 1));
        } else {
          throw new Error(`MAX RETRY of ${window.directoryPOC.MAX_RETRY} has been reached. Stopping due to: ${error}`);
        }
      });
    }

    function getPeopleLinks({ data }) {
      return data.map(({ relationships: { people: { links: { related } } } }) => `${related}?include=field_data`);
    }

    function requestFirstPageOfHouseholds() {
      return window.directoryPOC.apiRequest('https://api.planningcenteronline.com/people/v2/households?include=people&per_page=1');
    }

    function _isIncludeInTheOnlinePictorialDirectoryField(fieldDatum) {
      const FIELD_DEFINITION_ID = '830513';
      const {
        relationships: {
          customizable: {
            data: {
              type: customizableType
            }
          },
          field_definition: {
            data: {
              id,
              type: fieldDefinitionType
            }
          }
        }
      } = fieldDatum;

      return customizableType === 'Person' && fieldDefinitionType === 'FieldDefinition' && id === FIELD_DEFINITION_ID;
    }

    function _getPersonIdFromFieldDatum(fieldDatum) {
      const {
        relationships: {
          customizable: {
            data: {
              id
            }
          }
        }
      } = fieldDatum;

      return id;
    }

    function _getAllowedPeople({ included }) {
      return included
        .filter(_isIncludeInTheOnlinePictorialDirectoryField)
        .map(_getPersonIdFromFieldDatum);
    }

    function getAllowedPeopleList(apiLinks, apiCall) {
      return Promise.all(apiLinks.map((apiLink) => {
        return apiCall(apiLink).catch((error) => {
          console.warn(`caught this error while trying to reach ${apiLink}. A null will be return as the result. Should look into why this error is happening ${error}`);
          return null;
        });
      })).then((results) => {
        return results
          .filter((item) => item !== null)
          .flatMap(_getAllowedPeople)
      });
    }

    function displayHouseholds() {
      requestFirstPageOfHouseholds()
        .then(tap((x) => `inital call to household: ${x}`))
        .then((jsonResults) => getPeopleLinks(jsonResults))
        .then(tap((x) => `api links ready: ${x}`))
        .then((peopleApiLinks) => getAllowedPeopleList(peopleApiLinks, window.directoryPOC.apiRequest))
        .then(tap((x) => `white listed people ids: ${x}`));
    }

    function startHere() {

      const authInfo = window.localStorage.getItem('directoryAuthInfo');
      const authRedirectUrl = "https://api.planningcenteronline.com/oauth/authorize?client_id=1c60b5f9c9c37feedbbfe34ac0014b2b4f17ebfb71cd44bc6b702fd1ecec9d9f&redirect_uri=https://leadiv.github.io/directory-poc/auth-complete&response_type=code&scope=people";
      if (authInfo) {

        const { access_token, expires_in, created_at } = JSON.parse(authInfo);

        if (((created_at + expires_in - 300) * 1000) > Date.now()) {
          window.directoryPOC = {
            MAX_RETRY: 3,
            apiRequest: requestPCO(access_token)
          };

          displayHouseholds();
        } else {

          window.location.href = authRedirectUrl;
        }
      } else {

        window.location.href = authRedirectUrl;
      }
    }

    document.addEventListener("DOMContentLoaded", (event) => {
      startHere();
    });
  </script>
  <body>
    <section id="directory-body"></section>
    <section id="directory-nav"></section>
  </body>
</html>
