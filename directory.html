<html>
  <script>
    const MAX_RETRY = 3;

    const requestPeople = (access_token) => (apiEndpoint, retryCount = 1) => {
      return fetch(apiEndpoint, {
        headers: {
          Authorization: `Bearer ${access_token}`
        }
      }).then((response) => response.json()).catch((error) => {
        if (retryCount <= MAX_RETRY) {
          return window.directoryPOC.apiRequest(apiEndpoint, retryCount + 1);
        } else {
          throw new Error(`MAX RETRY of ${MAX_RETRY} has been reached. Stopping due to: ${error}`);
        }
      });
    }

    function requestFirstPageOfHouseholds() {
      window.directoryPOC.apiRequest('https://api.planningcenteronline.com/people/v2/households?include=people&per_page=1').then((json_results) => {
        console.log('The results', json_results);
      }
    }

    function displayHouseholds() {
        requestFirstPageOfHouseholds();
    }

    function startHere() {

      const authInfo = window.localStorage.getItem('directoryAuthInfo');
      const authRedirectUrl = "https://api.planningcenteronline.com/oauth/authorize?client_id=1c60b5f9c9c37feedbbfe34ac0014b2b4f17ebfb71cd44bc6b702fd1ecec9d9f&redirect_uri=https://leadiv.github.io/directory-poc/auth-complete&response_type=code&scope=people";
      if (authInfo) {

        const { access_token, expires_in, created_at } = JSON.parse(authInfo);

        if (((created_at + expires_in - 300) * 1000) > Date.now()) {
          window.directoryPOC = {
            apiRequest: requestPeople(access_token)
          };

          displayHouseholds();
        } else {

          window.location.href = authRedirectUrl;
        }
      } else {

        window.location.href = authRedirectUrl;
      }
    }

    document.addEventListener("DOMContentLoaded", (event) => {
      startHere();
    });
  </script>
  <body>
    <section id="directory-body"></section>
    <section id="directory-nav"></section>
  </body>
</html>
